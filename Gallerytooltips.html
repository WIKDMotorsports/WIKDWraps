<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WIKD Wraps - Master Build</title>
<script src="https://animatedicons.co/scripts/embed-animated-icons.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Import WIKD Fonts: Rajdhani & Inter -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
  :root {
    --color-background: #0A0A0A;
    --color-surface: #141414;
    --color-border: #2A2A2A;
    --color-text: #EAEAEA;
    --color-text-muted: #888888;
    
    --font-heading: 'Rajdhani', sans-serif;
    --font-body: 'Inter', sans-serif;
  }

  /* * CORE PAGE SETUP * */
  body {
    margin: 0;
    padding: 0;
    background-color: var(--color-background);
    color: var(--color-text);
    font-family: var(--font-body);
    height: 100vh;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  /* Noise Texture Overlay */
  body::before {
    content: "";
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
    z-index: 0;
    opacity: 0.08;
    background-size: 100px 100px;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%E3%8E%3C/svg%3E");
  }

  /* * CONTAINER * */
  .demo-container {
    position: relative; 
    width: 900px; 
    height: 600px; 
    border: 1px dashed var(--color-border); 
    border-radius: 20px;
    z-index: 1;
    background: radial-gradient(circle at center, rgba(20,20,20,0.5), transparent 70%);
  }

  /* =========================================
      HOTSPOT STYLES
     ========================================= */

  /* 1. SHARED BASE */
  .tune-hotspot {
    position: absolute;
    width: 24px;
    height: 24px;
    box-sizing: border-box; 
    cursor: pointer;
    z-index: 100; 
    transform: none; 
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  
  .tune-hotspot:hover {
    transform: scale(1.1);
    filter: brightness(1.2);
  }

  /* 2. CIRCLE (SERVICE) SPECIFIC */
  .tune-hotspot[data-type="service"] {
    border-radius: 50%;
    background: rgba(20, 20, 20, 0.4); 
    border: 2px solid rgba(255, 255, 255, 0.9); 
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
  }

  .tune-hotspot[data-type="service"]::before {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    background: currentColor;
    border-radius: 50%;
    box-shadow: 0 0 10px currentColor;
  }

  .tune-hotspot[data-type="service"]::after {
    content: '';
    position: absolute;
    top: -4px; left: -4px; right: -4px; bottom: -4px;
    border-radius: 50%;
    border: 1px solid currentColor;
    opacity: 0;
    animation: pulse-ring-circle 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
  }

  @keyframes pulse-ring-circle {
    0% { transform: scale(0.8); opacity: 0.6; }
    100% { transform: scale(2.0); opacity: 0; }
  }

  /* 3. TRIANGLE (NANO) SPECIFIC */
  .tune-hotspot[data-type="nano"] {
    width: 30px; 
    height: 26px;
    border: none;
    box-shadow: none;
    background: none; 
  }

  .tune-hotspot[data-type="nano"] svg {
    display: block;
    width: 100%;
    height: 100%;
    filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
  }

  .tune-hotspot[data-type="nano"]::after {
    content: '';
    position: absolute;
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    z-index: 0; 
    background: currentColor;
    clip-path: polygon(
      50% 0%, 0% 100%, 100% 100%, 50% 0%, 
      50% 2px, 98% 98%, 2% 98%, 50% 2px
    );
    opacity: 0;
    transform-origin: 50% 62%;
    animation: pulse-ring-triangle 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
  }

  @keyframes pulse-ring-triangle {
    0% { transform: scale(0.8); opacity: 0.6; }
    100% { transform: scale(2.0); opacity: 0; }
  }

  /* 4. SQUARE (PING) SPECIFIC - NEW CLASS */
  .tune-hotspot[data-type="ping"] {
    width: 24px; height: 24px;
    background: rgba(20, 20, 20, 0.6);
    border: 2px solid rgba(255, 255, 255, 0.9);
    border-radius: 2px; /* Slight radius for square */
    box-shadow: 0 0 10px rgba(0,0,0,0.8);
  }
  
  .tune-hotspot[data-type="ping"]::before {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 8px; height: 8px;
    background: currentColor;
    border-radius: 1px;
    box-shadow: 0 0 8px currentColor;
  }

  .tune-hotspot[data-type="ping"]::after {
    content: '';
    position: absolute;
    top: -4px; left: -4px; right: -4px; bottom: -4px;
    border: 1px solid currentColor;
    border-radius: 2px;
    opacity: 0;
    animation: pulse-ring-square 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
  }

  @keyframes pulse-ring-square {
    0% { transform: scale(0.8); opacity: 0.6; }
    100% { transform: scale(2.0); opacity: 0; }
  }


  /* =========================================
      TOOLTIP STYLES
     ========================================= */
  .tune-tooltip {
    position: absolute; 
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--theme-color, #fff); 
    border-radius: 4px; 
    box-shadow: 0 20px 40px -10px rgba(0,0,0,0.9), 0 0 0 1px rgba(0,0,0,0.5);
    opacity: 0;
    pointer-events: none;
    z-index: 9999; 
    visibility: hidden;
    
    /* ANIMATION START STATE (Normal / Top) */
    /* Start closer to the hotspot, smaller scale. Pivot from bottom. */
    transform: translateX(-50%) translateY(-100%) scale(0.5);
    transform-origin: bottom center; 
    transition: opacity 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), visibility 0.2s;
  }

  .tune-tooltip.type-service { width: 260px; padding: 16px; }
  .tune-tooltip.type-nano { width: 280px; padding: 16px; }
  
  /* UPDATED PING TOOLTIP: Larger, no padding, relative for overlay */
  .tune-tooltip.type-ping { 
    width: 320px; 
    height: 320px; 
    padding: 0; /* Remove default padding */
    display: flex;
    flex-direction: column;
    overflow: hidden;
    background: #000; /* Black background for 3D model */
  }

  .tune-tooltip.visible {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    /* ANIMATION END STATE (Normal / Top) */
    /* Expands UPWARDS away from mouse to resting position (-12px gap) */
    transform: translateX(-50%) translateY(calc(-100% - 12px)) scale(1);
  }

  /* FLIP ANIMATION (Bottom) */
  .tune-tooltip.flip { 
    /* Start closer to the hotspot, smaller scale. Pivot from top. */
    transform: translateX(-50%) translateY(0px) scale(0.5);
    transform-origin: top center;
  }
  
  .tune-tooltip.flip.visible { 
    /* Expands DOWNWARDS away from mouse to resting position (12px gap) */
    transform: translateX(-50%) translateY(12px) scale(1); 
  }

  .tune-tooltip::after {
    content: ''; position: absolute; left: 50%; width: 12px; height: 12px;
    background: var(--color-surface); border-right: 1px solid var(--color-border); border-bottom: 1px solid var(--color-border);
    transition: all 0.25s; top: 100%; transform: translateX(-50%) translateY(-6px) rotate(45deg); 
  }
  
  /* Fix arrow color for PING type (since bg is black/iframe) */
  .tune-tooltip.type-ping::after { background: #000; }

  .tune-tooltip.flip::after { top: -6px; transform: translateX(-50%) rotate(225deg); }

  /* CONTENT */
  .tt-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--color-border); height: 50px; }
  .tt-title { flex-grow: 1; min-width: 0; }
  .tt-title h4 { margin: 0; font-family: var(--font-heading); font-size: 20px; font-weight: 700; text-transform: uppercase; color: #fff; line-height: 1; margin-bottom: 2px; white-space: nowrap; }
  .tt-title span { font-size: 11px; color: var(--color-text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
  
  .tt-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }

  /* UPDATED STAT ITEM CONTAINER FOR FLIP */
  .stat-item { 
    background: rgba(255,255,255,0.02); 
    border-radius: 2px; 
    border: 1px solid transparent; 
    text-align: center; 
    transition: border-color 0.3s; 
    position: relative; /* Essential for overlap */
    height: 44px; /* Fixed height to prevent jumping */
    overflow: hidden; /* Hide the sliding text */
    /* cursor removed to allow default behavior */
    display: block; 
  }
  
  .tune-tooltip:hover .stat-item { border-color: rgba(255,255,255,0.05); }

  /* THE TWO FACES */
  .stat-face {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
    backface-visibility: hidden;
  }

  /* Default State */
  .stat-face.front { opacity: 1; transform: translateY(0); }
  .stat-face.back { opacity: 0; transform: translateY(100%); }

  /* Hover State */
  .stat-item:hover .stat-face.front { opacity: 0; transform: translateY(-100%); }
  .stat-item:hover .stat-face.back { opacity: 1; transform: translateY(0); }

  .stat-val { display: block; font-family: var(--font-heading); font-size: 18px; font-weight: 700; color: var(--theme-color); line-height: 1.1; }
  .type-nano .stat-val, .type-ping .stat-val { font-size: 20px; }
  .stat-label { font-size: 10px; color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
  
  .btn-learn { display: block; width: 100%; padding: 8px; text-align: center; background: rgba(255,255,255,0.05); color: var(--color-text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; text-decoration: none; border-radius: 2px; transition: all 0.2s; font-family: var(--font-heading); font-weight: 600; box-sizing: border-box; }
  .btn-learn:hover { background: var(--theme-color); color: #000; }
  
  .nano-chart-wrap { width: 100px; height: 40px; position: relative; flex-shrink: 0; margin-left: auto; }
  
  /* NEW STYLES FOR PING 3D OVERLAY */
  .ping-iframe-layer {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
  }
  .ping-iframe-layer iframe { width: 100%; height: 100%; border: none; }
  
  .ping-content-layer {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
    pointer-events: none; /* Allows interaction with 3D model behind */
    display: flex; flex-direction: column; justify-content: space-between;
    padding: 24px; box-sizing: border-box;
    background: linear-gradient(to bottom, rgba(0,0,0,0.85) 0%, transparent 40%, transparent 60%, rgba(0,0,0,0.9) 100%);
  }
  
  .ping-header-text h4 { 
    margin: 0; font-family: var(--font-heading); font-size: 24px; font-weight: 700; text-transform: uppercase; color: #fff; text-shadow: 0 2px 8px rgba(0,0,0,0.8); line-height: 1; margin-bottom: 4px; 
  }
  .ping-header-text span { 
    font-size: 12px; color: rgba(255,255,255,0.9); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
  }
  
  .ping-content-layer .btn-learn {
    pointer-events: auto; /* Re-enable clicks for the button */
    background: var(--theme-color); color: #000; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: none; font-weight: 700;
  }
  .ping-content-layer .btn-learn:hover { filter: brightness(1.15); }

  canvas { width: 100% !important; height: 100% !important; }
  .tune-bar-wrap { width: 100%; height: 4px; background: rgba(255,255,255,0.1); overflow: hidden; position: relative; margin-top: 4px; }
  .tune-bar-fill { height: 100%; width: 0; background: var(--theme-color); box-shadow: 0 0 10px var(--theme-color); transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); }

</style>
</head>
<body>

  <div class="demo-container">
    <div style="position:absolute; bottom: 20px; left: 20px; color: var(--color-text-muted); font-family: var(--font-body); font-size: 12px; letter-spacing: 1px; text-transform: uppercase;">
      WIKD // Service & Nano Tech // 3D Integration
    </div>
    
    <!-- SERVICE HOTSPOTS -->
    <div class="tune-hotspot" data-id="ppf" data-type="service" style="top: 40%; left: 15%; color: #536DFE;"></div>
    <div class="tune-hotspot" data-id="ceramic" data-type="service" style="top: 55%; left: 40%; color: #00E676;"></div>
    <div class="tune-hotspot" data-id="vinyl" data-type="service" style="top: 45%; left: 60%; color: #FFD600;"></div>
    <div class="tune-hotspot" data-id="tint" data-type="service" style="top: 25%; left: 55%; color: #D500F9;"></div>
    <div class="tune-hotspot" data-id="detail" data-type="service" style="top: 70%; left: 75%; color: #FF3B30;"></div>

    <!-- NANO HOTSPOTS (Triangles) -->
    <div class="tune-hotspot" data-id="stage1" data-type="nano" style="top: 15%; left: 20%; color: #ffffff;"></div>
    <div class="tune-hotspot" data-id="stage2" data-type="nano" style="top: 65%; left: 30%; color: #FDE047;"></div>
    <div class="tune-hotspot" data-id="stage3" data-type="nano" style="top: 35%; left: 75%; color: #f97316;"></div>
    <div class="tune-hotspot" data-id="wikd" data-type="nano" style="top: 50%; left: 50%; color: #FF3B30;"></div>

    <!-- PING HOTSPOTS (Square with 3D Embed) -->
    <!-- Downpipe -->
    <div class="tune-hotspot" data-id="mclaren" data-type="ping" style="top: 25%; left: 85%; color: #9370DB;"></div>
    <!-- Cat-Back (NEW) -->
    <div class="tune-hotspot" data-id="mclaren_catback" data-type="ping" style="top: 55%; left: 15%; color: #9370DB;"></div>

  </div>

<script>
  const SERVICE_DATA = {
    "ppf": { 
      title: "Paint Protection Film", desc: "Ultimate Shield", color: "#536DFE", url: "https://wikdwraps.com/pages/paint-protection-film", iconName: "Security", iconToken: "af857f3d-6096-42d0-9f04-a9ee72f54aa4", 
      stat1: { val: "10â€“12 Yrs", label: "Warranty", altVal: "STEK", altLabel: "Authorized" },
      stat2: { val: "Certified", label: "Installers", altVal: "Precision", altLabel: "Cut Patterns" }
    },
    "ceramic": { 
      title: "Ceramic Coating", desc: "Liquid Glass", color: "#00E676", url: "https://wikdwraps.com/pages/ceramic-coatings", iconName: "Chemist", iconToken: "153ce80d-3f45-4dc6-b13a-40ea011dbbfe", 
      stat1: { val: "9H", label: "Hardness", altVal: "Anti", altLabel: "Scratch" },
      stat2: { val: "High", label: "Hydrophobic", altVal: "Self", altLabel: "Cleaning" }
    },
    "vinyl": { 
      title: "Vinyl Wraps", desc: "Instant Transformation", color: "#FFD600", url: "https://wikdwraps.com/pages/vinyl-wraps", iconName: "Palette", iconToken: "6defc96c-bfac-4d99-bc45-98649e19863b", 
      stat1: { val: "300+", label: "Colors", altVal: "Matte/Gloss", altLabel: "Finishes" },
      stat2: { val: "Custom", label: "Graphics", altVal: "Fleet", altLabel: "Branding" }
    },
    "tint": { 
      title: "Window Tint", desc: "Heat Rejection", color: "#D500F9", url: "https://wikdwraps.com/pages/window-tint", iconName: "Sunglasses", iconToken: "af857f3d-6096-42d0-9f04-a9ee72f54aa4", 
      stat1: { val: "99%", label: "UV Block", altVal: "Max", altLabel: "IR Rejection" },
      stat2: { val: "Lifetime", label: "Warranty", altVal: "Color", altLabel: "Stable" }
    },
    "detail": { 
      title: "Detailing", desc: "Restore & Maintain", color: "#FF3B30", url: "https://wikdwraps.com/pages/detailing", iconName: "Mop", iconToken: "86b68190-0253-4375-8994-96f5611b9f19", 
      stat1: { val: "Clean", label: "& Seal", altVal: "Deep", altLabel: "Decon" },
      stat2: { val: "Showroom", label: "Finish", altVal: "Paint", altLabel: "Correction" }
    }
  };

  const TUNING_DATA = {
    "stage1": { 
        label:"Stage 1", desc: "Stock to Bolt-Ons", 
        stat1: { val: "< 500", label: "WHP", altVal: "$1000+", altLabel: "Starting" },
        stat2: { val: "Street", label: "Application", altVal: "ECU / TCU", altLabel: "Tuning" },
        percent:45, color:"#ffffff", curveType: "roots", fillOpacity: 0.1, strokeWidth: 1.5, iconName: "KM", iconToken: "5729fdff-2cfc-4b8b-9952-2ff7da52563d" 
    },
    "stage2": { 
        label:"Stage 2", desc: "Alternative Fuels", 
        stat1: { val: "500+", label: "WHP", altVal: "$1250+", altLabel: "Starting" },
        stat2: { val: "E85 / Meth", label: "Fuels", altVal: "Trans", altLabel: "Tuning" },
        percent:65, color:"#FDE047", curveType: "sport", fillOpacity: 0.25, strokeWidth: 2, iconName: "KM", iconToken: "5729fdff-2cfc-4b8b-9952-2ff7da52563d" 
    },
    "stage3": { 
        label:"Stage 3", desc: "Power Adders", 
        stat1: { val: "800+", label: "WHP", altVal: "$1500+", altLabel: "Starting" },
        stat2: { val: "Turbo / SC", label: "Boost", altVal: "Multi", altLabel: "Fuel" },
        percent:85, color:"#f97316", curveType: "track", fillOpacity: 0.4, strokeWidth: 2, iconName: "KM", iconToken: "5729fdff-2cfc-4b8b-9952-2ff7da52563d" 
    },
    "wikd": { 
        label:"WIKD", desc: "Race Applications", 
        stat1: { val: "1000+", label: "WHP", altVal: "$1750+", altLabel: "Starting" },
        stat2: { val: "Comp", label: "Builds", altVal: "Track", altLabel: "Support" },
        percent:100, color:"#FF3B30", curveType: "procharger", fillOpacity: 0.65, strokeWidth: 3, iconName: "KM", iconToken: "5729fdff-2cfc-4b8b-9952-2ff7da52563d" 
    }
  };

  // NEW PING DATA (SQUARE) with 3D Model Embed
  const PING_DATA = {
    "mclaren": {
        label: "McLaren 720S", desc: "Ti Decat Downpipe",
        percent: 100, color: "#9370DB", 
        embedUrl: "https://playcanv.as/b/7ae24e57?noui",
        url: "https://www.wikdmotorsports.com/pages/mclaren-720s-decat-titanium-downpipe-2018-brushed-purple"
    },
    "mclaren_catback": {
        label: "McLaren 720S", desc: "Ti Cat-Back Exhaust",
        percent: 100, color: "#9370DB",
        embedUrl: "https://playcanv.as/b/f471d70a?noui",
        url: "https://www.wikdmotorsports.com/pages/mclaren-720s-titanium-catback-2018"
    }
  };

  const BASE_DYNO_DATA = [
    { rpm: 3000, horsepower: 380, torque: 670 }, { rpm: 3100, horsepower: 410, torque: 690 }, { rpm: 3200, horsepower: 440, torque: 720 }, { rpm: 3300, horsepower: 480, torque: 760 },
    { rpm: 3400, horsepower: 530, torque: 815 }, { rpm: 3500, horsepower: 580, torque: 870 }, { rpm: 3600, horsepower: 620, torque: 900 }, { rpm: 3700, horsepower: 650, torque: 920 },
    { rpm: 3800, horsepower: 670, torque: 925 }, { rpm: 3900, horsepower: 690, torque: 930 }, { rpm: 4000, horsepower: 710, torque: 935 }, { rpm: 4100, horsepower: 735, torque: 940 },
    { rpm: 4200, horsepower: 760, torque: 950 }, { rpm: 4300, horsepower: 785, torque: 960 }, { rpm: 4400, horsepower: 810, torque: 965 }, { rpm: 4500, horsepower: 830, torque: 970 },
    { rpm: 4600, horsepower: 855, torque: 975 }, { rpm: 4700, horsepower: 880, torque: 980 }, { rpm: 4800, horsepower: 910, torque: 995 }, { rpm: 4900, horsepower: 940, torque: 1010 },
    { rpm: 5000, horsepower: 970, torque: 1020 }, { rpm: 5100, horsepower: 995, torque: 1025 }, { rpm: 5200, horsepower: 1020, torque: 1030 }, { rpm: 5300, horsepower: 1050, torque: 1035 },
    { rpm: 5400, horsepower: 1080, torque: 1040 }, { rpm: 5500, horsepower: 1110, torque: 1045 }, { rpm: 5600, horsepower: 1140, torque: 1045 }, { rpm: 5700, horsepower: 1170, torque: 1040 },
    { rpm: 5800, horsepower: 1200, torque: 1038 }, { rpm: 5900, horsepower: 1225, torque: 1035 }, { rpm: 6000, horsepower: 1250, torque: 1030 }, { rpm: 6100, horsepower: 1270, torque: 1025 },
    { rpm: 6200, horsepower: 1285, torque: 1020 }, { rpm: 6300, horsepower: 1300, torque: 1015 }, { rpm: 6400, horsepower: 1310, torque: 1010 }, { rpm: 6500, horsepower: 1315, torque: 1005 },
    { rpm: 6600, horsepower: 1310, torque: 990 }, { rpm: 6700, horsepower: 1300, torque: 970 }, { rpm: 6800, horsepower: 1280, torque: 930 }
  ];

  const hexToRgba = (hex, alpha) => {
    let r = 0, g = 0, b = 0;
    if (hex.length === 4) { r = parseInt(hex[1]+hex[1],16); g = parseInt(hex[2]+hex[2],16); b = parseInt(hex[3]+hex[3],16); }
    else if (hex.length === 7) { r = parseInt(hex.substring(1,3),16); g = parseInt(hex.substring(3,5),16); b = parseInt(hex.substring(5,7),16); }
    return `rgba(${r},${g},${b},${alpha})`;
  };

  const generateCurveData = (curveType) => {
     return BASE_DYNO_DATA.map(d => {
       let hp = d.horsepower, tq = d.torque, rpm = d.rpm;
       if (curveType === "roots") { tq = 650; if (rpm > 4500) tq -= (rpm - 4500) * 0.15; hp = (tq * rpm) / 5252; } 
       else if (curveType === "sport") { tq = 800; if (rpm > 5500) tq -= (rpm - 5500) * 0.2; hp = (tq * rpm) / 5252; }
       else if (curveType === "track") { tq = 900; if (rpm > 6000) tq -= (rpm - 6000) * 0.1; hp = (tq * rpm) / 5252; }
       return { rpm, horsepower: hp, torque: tq };
     });
  };

  // STORE CURVE DATA GLOBALLY FOR REUSE
  const CURVE_CACHE = {};

  const createNanoChart = (canvasId, tune) => {
    const ctx = document.getElementById(canvasId).getContext('2d');
    // Pre-calculate full data set but don't give it to chart yet
    CURVE_CACHE[canvasId] = generateCurveData(tune.curveType);
    
    // Initialize with EMPTY data for manual drawing
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: CURVE_CACHE[canvasId].map(d => d.rpm), // Labels are fine to have
        datasets: [
          { 
            label: 'HP', 
            data: [], // START EMPTY
            borderColor: tune.color, 
            backgroundColor: 'transparent',
            fill: true, 
            borderWidth: tune.strokeWidth, 
            pointRadius: 0, 
            tension: 0.4, 
            yAxisID: 'y' 
          },
          { 
            label: 'TQ', 
            data: [], // START EMPTY
            borderColor: 'rgba(255, 165, 0, 0.5)', 
            borderWidth: 1, 
            borderDash: [2, 2], 
            pointRadius: 0, 
            tension: 0.4, 
            yAxisID: 'y' 
          }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: false } },
        scales: { x: { display: false }, y: { display: false, min: 0, max: 1400 } },
        animation: false // DISABLE CHARTJS ANIMATION ENGINE COMPLETELY
      }
    });
  };

  // Easing function: Cubic smoothing (matching a classic CSS ease)
  function easeInOutCubic(t) {
    return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
  }
  
  const drawChartEased = (chartInstance, canvasId, tune) => {
      const fullData = CURVE_CACHE[canvasId];
      if(!fullData) return;

      const hpDataset = chartInstance.data.datasets[0];
      const tqDataset = chartInstance.data.datasets[1];
      
      // Reset State
      hpDataset.data = [];
      tqDataset.data = [];
      hpDataset.backgroundColor = 'transparent';
      chartInstance.stop(); // Stop any competing internal animations
      
      const duration = 1000; // 1 second duration, synchronized with CSS bar
      const startTime = performance.now();
      const totalPoints = fullData.length;
      const ctx = chartInstance.ctx;
      
      let animationFrameId; // To hold the RAF ID

      const drawStep = (currentTime) => {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          
          // Easing for the draw and fade
          const easedProgress = easeInOutCubic(progress);

          // 1. Line Drawing
          const pointsToRender = Math.floor(totalPoints * easedProgress);
          
          if (pointsToRender > hpDataset.data.length) {
              hpDataset.data = fullData.slice(0, pointsToRender).map(p => p.horsepower);
              tqDataset.data = fullData.slice(0, pointsToRender).map(p => p.torque);
          }

          // 2. Gradient Fading (Runs simultaneously with the line draw)
          const opacity = easedProgress * tune.fillOpacity;

          const gradient = ctx.createLinearGradient(0, 0, 0, 40);
          gradient.addColorStop(0, hexToRgba(tune.color, opacity));
          gradient.addColorStop(1, 'rgba(0,0,0,0)');
          chartInstance.data.datasets[0].backgroundColor = gradient;
          
          chartInstance.update('none'); // Render frame without internal animation

          if (progress < 1) {
              animationFrameId = requestAnimationFrame(drawStep);
          } else {
              // Animation finished cleanly.
          }
      };
      
      animationFrameId = requestAnimationFrame(drawStep);
  };

  document.addEventListener("DOMContentLoaded", () => {
    const demoContainer = document.querySelector('.demo-container');
    const chartInstances = {};

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.tune-hotspot') && !e.target.closest('.tune-tooltip')) closeAllTooltips();
    });

    function closeAllTooltips() {
      document.querySelectorAll('.tune-tooltip.visible').forEach(tt => {
         tt.classList.remove('visible');
         tt.classList.remove('locked');
         tt.classList.remove('flip');
         const bar = tt.querySelector(".tune-bar-fill");
         if(bar) bar.style.width = "0%";
      });
    }

    document.querySelectorAll(".tune-hotspot").forEach(hotspot => {
      const id = hotspot.dataset.id;
      const type = hotspot.dataset.type;
      let data, htmlContent, chartId;

      if (type === 'service') {
        data = SERVICE_DATA[id];
        if(!data) return;
        const iconAttrs = JSON.stringify({ variationThumbColour: data.color, variationName: "Two Tone", variationNumber: 2, numberOfGroups: 2, backgroundIsGroup: false, strokeWidth: 1, defaultColours: { "group-1": data.color, "group-2": data.color, "background": "#141414" } });
        
        htmlContent = `
          <div class="tt-header">
             <animated-icons src="https://animatedicons.co/get-icon?name=${data.iconName}&style=minimalistic&token=${data.iconToken}" trigger="loop" attributes='${iconAttrs.replace(/'/g, "&apos;")}' height="38" width="38"></animated-icons>
            <div class="tt-title"><h4>${data.title}</h4><span>${data.desc}</span></div>
          </div>
          <div class="tt-stats">
            <div class="stat-item">
                <div class="stat-face front"><span class="stat-val">${data.stat1.val}</span><span class="stat-label">${data.stat1.label}</span></div>
                <div class="stat-face back"><span class="stat-val">${data.stat1.altVal}</span><span class="stat-label">${data.stat1.altLabel}</span></div>
            </div>
            <div class="stat-item">
                <div class="stat-face front"><span class="stat-val">${data.stat2.val}</span><span class="stat-label">${data.stat2.label}</span></div>
                <div class="stat-face back"><span class="stat-val">${data.stat2.altVal}</span><span class="stat-label">${data.stat2.altLabel}</span></div>
            </div>
          </div>
          <a href="${data.url}" target="_blank" class="btn-learn">View Service Details</a>
        `;
      } else if (type === 'nano') {
        data = TUNING_DATA[id];
        if(!data) return;
        const iconAttrs = JSON.stringify({ variationThumbColour: data.color, variationName: "Two Tone", variationNumber: 2, numberOfGroups: 2, backgroundIsGroup: false, strokeWidth: 2, defaultColours: { "group-1": "#EAEAEA", "group-2": data.color, "background": "#141414" } });
        chartId = `nano-chart-${id}`;
        
        htmlContent = `
          <div class="tt-header">
             <animated-icons src="https://animatedicons.co/get-icon?name=${data.iconName}&style=minimalistic&token=${data.iconToken}" trigger="loop" attributes='${iconAttrs.replace(/'/g, "&apos;")}' height="32" width="32"></animated-icons>
            <div class="tt-title"><h4>${data.label}</h4><span>${data.desc}</span></div>
            <div class="nano-chart-wrap"><canvas id="${chartId}"></canvas></div>
          </div>
          <div class="tt-stats">
            <a href="https://www.wikdmotorsports.com/pages/tuning" target="_blank" class="stat-item">
                <div class="stat-face front"><span class="stat-val">${data.stat1.val}</span><span class="stat-label">${data.stat1.label}</span></div>
                <div class="stat-face back"><span class="stat-val">${data.stat1.altVal}</span><span class="stat-label">${data.stat1.altLabel}</span></div>
            </a>
            <a href="https://www.wikdmotorsports.com/pages/tuning" target="_blank" class="stat-item">
                <div class="stat-face front"><span class="stat-val">${data.stat2.val}</span><span class="stat-label">${data.stat2.label}</span></div>
                <div class="stat-face back"><span class="stat-val">${data.stat2.altVal}</span><span class="stat-label">${data.stat2.altLabel}</span></div>
            </a>
          </div>
          <div class="tune-bar-wrap"><div class="tune-bar-fill"></div></div>
          <a href="https://www.wikdmotorsports.com/pages/tuning" target="_blank" class="btn-learn" style="margin-top:12px;">View Tuning Packages</a>
        `;
      } else if (type === 'ping') { // NEW TYPE: PING (Square)
        data = PING_DATA[id];
        if(!data) return;
        
        // PING HTML STRUCTURE - Full Card Overlay
        htmlContent = `
          <div class="ping-iframe-layer"><iframe src="${data.embedUrl}" allowfullscreen></iframe></div>
          <div class="ping-content-layer">
              <div class="ping-header-text">
                  <h4>${data.label}</h4>
                  <span>${data.desc}</span>
              </div>
              <a href="${data.url}" target="_blank" class="btn-learn">View Product</a>
          </div>
        `;
      }

      const tt = document.createElement("div");
      tt.className = `tune-tooltip type-${type}`;
      tt.style.setProperty('--theme-color', data.color);
      
      if (type === 'nano') {
          hotspot.innerHTML = `
            <svg width="30" height="26" viewBox="0 0 30 26" fill="none" style="display:block;">
              <path d="M15 2 L27 24 L3 24 Z" fill="rgba(20,20,20,0.4)" stroke="rgba(255,255,255,0.9)" stroke-width="2" stroke-linejoin="round"/>
              <path d="M15 13 L19 19 L11 19 Z" fill="${data.color}" />
            </svg>
          `;
      }
      // PING uses default Square CSS defined in style, no inner HTML needed.

      const updatePosition = () => {
          const cx = hotspot.offsetLeft + (hotspot.offsetWidth / 2);
          const cy = hotspot.offsetTop + (hotspot.offsetHeight / 2);
          tt.style.left = cx + 'px';
          tt.style.top = cy + 'px';
      }
      
      tt.innerHTML = htmlContent;
      demoContainer.appendChild(tt);
      updatePosition(); 

      if (type === 'nano' && chartId) chartInstances[id] = createNanoChart(chartId, data);

      let hideTimeout;
      const bar = tt.querySelector(".tune-bar-fill");

      const show = (lock = false) => {
        clearTimeout(hideTimeout);
        updatePosition(); 

        const hotspotRect = hotspot.getBoundingClientRect();
        const ttHeight = tt.offsetHeight;
        const PADDING = 40;
        
        if (hotspotRect.top - ttHeight - 12 < PADDING) tt.classList.add('flip'); 
        else tt.classList.remove('flip'); 

        const isAlreadyVisible = tt.classList.contains('visible');
        tt.classList.add('visible');
        
        // ANIMATION HANDLERS
        // Nano: Chart + Bar
        if(type === 'nano') {
          if(!isAlreadyVisible && !tt.classList.contains('locked')) {
             drawChartEased(chartInstances[id], chartId, data);
             if(bar) {
                bar.style.width = "0%"; 
                requestAnimationFrame(() => { requestAnimationFrame(() => { bar.style.width = data.percent + "%"; }); });
             }
          }
        }

        if (lock) {
          closeAllTooltips();
          tt.classList.add('locked');
          tt.classList.add('visible'); 
           if(type === 'nano' && bar) {
             bar.style.width = data.percent + "%";
           }
        }
      };

      const hide = () => {
        if (tt.classList.contains('locked')) return;
        hideTimeout = setTimeout(() => {
           if (!hotspot.matches(':hover') && !tt.matches(':hover')) {
             tt.classList.remove("visible");
             if(bar) bar.style.width = "0%";
           }
        }, 100);
      };

      hotspot.addEventListener("mouseenter", () => show(false));
      hotspot.addEventListener("mouseleave", hide);
      tt.addEventListener("mouseenter", () => show(false));
      tt.addEventListener("mouseleave", hide);
      
      hotspot.addEventListener("click", (e) => {
        e.stopPropagation();
        if (tt.classList.contains('locked')) { tt.classList.remove('locked'); hide(); } 
        else { show(true); }
      });
    });
  });
</script>
</body>
</html>
