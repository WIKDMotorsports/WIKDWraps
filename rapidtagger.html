<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rapid Tagger (Manual Export)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg: #000000; 
      --panel: #0a0a0a; 
      --border: #222;
      --text: #e0e0e0; 
      --text-muted: #666;
      --accent: #536DFE;
      
      /* WIKD Colors */
      --c-service: #536DFE;
      --c-nano: #FFFFFF;
      --c-ping: #9370DB;
      --c-danger: #ef4444;
      --c-success: #00E676;
    }

    /* GLOBAL SCROLLBARS */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--panel); }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    * { box-sizing: border-box; outline: none; }

    body {
      margin: 0; height: 100vh; background: var(--bg); color: var(--text);
      font-family: 'Inter', sans-serif; 
      display: grid; 
      /* GRID: Left (280px) - Center (Flex) - Right (280px) */
      grid-template-columns: 280px 1fr 280px;
      overflow: hidden;
    }

    /* --- SIDEBAR STRUCTURE --- */
    .sidebar {
      background: var(--panel);
      display: flex; flex-direction: column;
      height: 100vh;
      z-index: 100;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .sidebar-left { border-right: 1px solid var(--border); }
    .sidebar-right { border-left: 1px solid var(--border); }
    
    .sidebar-header { 
        padding: 14px 16px; 
        border-bottom: 1px solid var(--border); 
        display: flex; justify-content: space-between; align-items: center; 
        background: #0f0f0f;
        position: relative; 
    }
    
    .sidebar-scroll { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 24px; }
    
    .sidebar-footer {
        padding: 16px; border-top: 1px solid var(--border);
        background: #0f0f0f;
    }

    /* TYPOGRAPHY */
    h2 { font-size: 16px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }
    
    .section-header { 
      font-family: 'Rajdhani', sans-serif;
      font-size: 12px; text-transform: uppercase; letter-spacing: 1px; 
      color: var(--accent); font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
    }
    .section-header::after { content:''; flex:1; height:1px; background: #222; }

    /* INPUTS */
    .input-group { position: relative; }
    
    input.info-input {
      width: 100%; 
      background: #141414; 
      border: 1px solid #2a2a2a; 
      color: #e0e0e0;
      padding: 10px 12px; font-family: 'Inter', sans-serif; font-size: 12px; border-radius: 6px;
      transition: all 0.2s;
    }
    
    input.info-input:focus { 
        border-color: var(--accent); background: #1a1a1a; 
        box-shadow: 0 0 0 1px rgba(83, 109, 254, 0.2);
    }
    
    .input-label { font-size: 10px; color: var(--text-muted); margin-bottom: 4px; display: block; font-weight: 500; transition: color 0.2s; }


    /* GUIDE PANEL */
    .guide-btn { background:none; border:none; color:#666; font-size:10px; font-weight:700; cursor:pointer; letter-spacing:1px; text-transform:uppercase; transition: color 0.2s; }
    .guide-btn:hover { color: #fff; }
    
    .guide-panel {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: rgba(10,10,10,0.98);
        border-bottom: 1px solid var(--accent);
        padding: 16px;
        z-index: 200;
        backdrop-filter: blur(10px);
        box-shadow: 0 20px 50px rgba(0,0,0,0.8);
    }
    .guide-panel.open { display: block; }
    
    .guide-item { margin-bottom: 12px; font-size: 11px; color: #888; line-height: 1.5; border-bottom: 1px solid #1a1a1a; padding-bottom: 8px; }
    .guide-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .guide-item strong { color: #e0e0e0; display: block; margin-bottom: 2px; font-size: 12px; font-family: 'Rajdhani', sans-serif; letter-spacing: 0.5px; }
    .k-bd { display: inline-block; padding: 0 4px; background: #222; border: 1px solid #333; border-radius: 3px; color: var(--accent); font-family: monospace; font-size: 10px; margin: 0 2px; }

    
    /* TOOL GRID */
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    .tool-btn {
      position: relative;
      background: #141414; border: 1px solid #2a2a2a;
      color: #888; padding: 12px 4px; border-radius: 6px;
      cursor: pointer; font-size: 11px; font-weight: 600; text-align: center;
      transition: all 0.1s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
    }
    .tool-btn:hover { background: #1f1f1f; color: #fff; border-color: #444; }
    
    /* Active States */
    .tool-btn.active { background: #1f1f1f; border-color: currentColor; box-shadow: inset 0 0 0 1px currentColor; }
    .tool-btn[data-type="service"].active { color: var(--c-service); }
    .tool-btn[data-type="nano"].active { color: var(--c-nano); }
    .tool-btn[data-type="ping"].active { color: var(--c-ping); }
    
    .tool-btn[data-type="delete"]:hover { border-color: var(--c-danger); color: var(--c-danger); }
    .tool-btn[data-type="delete"].active { background: var(--c-danger); color: #fff; border-color: var(--c-danger); }
    
    .hk { position: absolute; top: 3px; right: 5px; font-size: 8px; opacity: 0.3; font-family: monospace; }

    /* COPY BUTTON (Replaces Bake) */
    .copy-btn {
        width: 100%; padding: 14px; 
        background: var(--accent); /* Use primary accent color */
        border: none; border-radius: 6px;
        color: #000; font-family: 'Rajdhani', sans-serif; font-size: 16px; font-weight: 800;
        text-transform: uppercase; cursor: pointer; letter-spacing: 1px;
        transition: 0.2s;
    }
    .copy-btn:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(83, 109, 254, 0.2); }
    .copy-btn:active { transform: translateY(1px); }

    /* CANVAS AREA */
    .canvas-area {
      position: relative; background: #000; 
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
      box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
    }
    .upload-prompt { pointer-events: none; text-align: center; color: #333; font-family: 'Rajdhani', sans-serif; }
    
    .img-wrap { position: relative; box-shadow: 0 0 50px #000; max-width: 95%; max-height: 95%; }
    img#targetImg { display: block; max-width: 100%; max-height: 95vh; pointer-events: none; }
    .click-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; z-index: 10; }

    /* MARKERS */
    .marker {
      position: absolute; width: 24px; height: 24px; transform: translate(-50%, -50%);
      pointer-events: auto; cursor: grab; z-index: 20; display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: bold; text-shadow: 0 1px 2px #000; transition: transform 0.1s;
    }
    .marker:hover {
        z-index: 1000 !important; 
    }
    .marker[data-type="service"] { border-radius: 50%; border: 2px solid #fff; background: rgba(0,0,0,0.5); }
    .marker[data-type="service"]::after { content:''; width: 6px; height: 6px; background: currentColor; border-radius: 50%; }
    .marker[data-type="nano"] { width: 30px; height: 26px; }
    .marker[data-type="ping"] { width: 20px; height: 20px; border: 2px solid #fff; background: rgba(0,0,0,0.6); border-radius: 2px; }
    .marker[data-type="ping"]::after { content:''; width: 6px; height: 6px; background: currentColor; }
    
    .marker svg { width: 100%; height: 100%; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.8)); }

    /* CUSTOM TOOLTIP LABEL */
    .marker-label {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(-5px);
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-family: 'Inter', sans-serif;
        font-weight: 700;
        white-space: nowrap;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.1s ease, transform 0.1s ease;
        z-index: 100;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .marker:hover .marker-label {
        opacity: 1;
        transform: translateX(-50%) translateY(-10px);
    }

    /* OUTPUT & EXTRAS */
    .output-bar {
        font-size: 10px; color: #555; display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;
    }

    @media (max-width: 1000px) {
        body { grid-template-columns: 240px 1fr 240px; }
    }
  </style>
</head>
<body>

  <!-- LEFT SIDEBAR: ASSETS & INFO -->
  <div class="sidebar sidebar-left">
    <div class="sidebar-header">
      <div style="display:flex; align-items:center; gap:10px;">
          <h2 style="margin:0">RAPID TAGGER</h2>
      </div>
      <button onclick="toggleGuide()" class="guide-btn">QUICK GUIDE ▼</button>
      
      <!-- COMPREHENSIVE GUIDE PANEL -->
      <div id="quickGuide" class="guide-panel">
          <div class="guide-item">
              <strong>1. ADD SOURCE</strong>
              Paste Image URL (or Base64 data) into the field below and press <span class="k-bd">ENTER</span> to load it.
          </div>
          <div class="guide-item">
              <strong>2. TAGGING</strong>
              Select a tool (Right Panel) and click on the image to place a marker.<br>
              <br>
              Shortcuts:<br>
              Services: <span class="k-bd">1-5</span>, Tuning: <span class="k-bd">QWER</span>, Parts: <span class="k-bd">AS</span><br>
              Remove: <span class="k-bd">D</span> (then click marker)
          </div>
          <div class="guide-item">
              <strong>3. EXPORT</strong>
              Click 'COPY JSON' to get the tags, metadata, and image URL in a JSON format.
          </div>
      </div>
    </div>

    <div class="sidebar-scroll">
      
      <!-- 1. SOURCE (Simplified Input) -->
      <div>
        <div class="section-header">1. IMAGE SOURCE</div>
        <div class="input-group">
             <input type="text" id="addUrlInput" class="info-input" placeholder="Paste Image URL or Base64 here..." onkeydown="handleUrlInput(event)">
        </div>
      </div>

      <!-- 2. PROJECT INFO (Manual Metadata) -->
      <div>
        <div class="section-header">2. METADATA (MANUAL)</div>
        <div id="projectInfoContainer" style="display:flex; flex-direction:column; gap:10px;">
            <div>
                <span class="input-label">PROJECT TITLE</span>
                <input type="text" id="projTitle" class="info-input" placeholder="e.g. McLaren 720S">
            </div>
            <div>
                <span class="input-label">TAGS (AUTO-GENERATED)</span>
                <div style="display:flex; gap:6px;">
                    <input type="text" id="projSubtitle" class="info-input" placeholder="Generated..." style="color:#e0e0e0;">
                    <button id="refreshTagsBtn" class="tool-btn" style="width:30px; padding:0; flex-shrink:0;" title="Reset to Auto-Tags" onclick="resetTagsToAuto()">↻</button>
                </div>
            </div>
        </div>
      </div>
      
    </div>
  </div>


  <!-- CENTER: CANVAS -->
  <div class="canvas-area">
    <div class="upload-prompt" id="prompt">
      <h1 id="promptText" style="font-size:40px; opacity:0.1; letter-spacing:4px;">START HERE</h1>
    </div>
    
    <div class="img-wrap" id="imgWrap" style="display:none">
      <img id="targetImg">
      <div class="click-layer" id="clickLayer"></div>
      <div id="markerContainer"></div>
    </div>
  </div>


  <!-- RIGHT SIDEBAR: TOOLS & ACTIONS -->
  <div class="sidebar sidebar-right">
    <div class="sidebar-header" style="justify-content:center;">
        <span style="font-size:10px; font-weight:700; color:#555; letter-spacing:1px;">TOOLBOX</span>
    </div>
    
    <div class="sidebar-scroll">
        
        <!-- SERVICE TAGS -->
        <div>
            <div class="section-header">SERVICES</div>
            <div class="btn-grid">
                <div class="tool-btn" onclick="setTool('ppf', 'service')" data-type="service">PPF <span class="hk">1</span></div>
                <div class="tool-btn" onclick="setTool('ceramic', 'service')" data-type="service">Ceramic <span class="hk">2</span></div>
                <div class="tool-btn" onclick="setTool('vinyl', 'service')" data-type="service">Vinyl <span class="hk">3</span></div>
                <div class="tool-btn" onclick="setTool('tint', 'service')" data-type="service">Tint <span class="hk">4</span></div>
                <div class="tool-btn" onclick="setTool('detail', 'service')" data-type="service">Detail <span class="hk">5</span></div>
            </div>
        </div>

        <!-- TUNING -->
        <div>
            <div class="section-header">PERFORMANCE / NANO</div>
            <div class="btn-grid">
                <div class="tool-btn" onclick="setTool('stage1', 'nano')" data-type="nano">Stage 1 <span class="hk">Q</span></div>
                <div class="tool-btn" onclick="setTool('stage2', 'nano')" data-type="nano">Stage 2 <span class="hk">W</span></div>
                <div class="tool-btn" onclick="setTool('stage3', 'nano')" data-type="nano">Stage 3 <span class="hk">E</span></div>
                <div class="tool-btn" onclick="setTool('wikd', 'nano')" data-type="nano">WIKD <span class="hk">R</span></div>
            </div>
        </div>

        <!-- PRODUCTS -->
        <div>
            <div class="section-header">PARTS / PING</div>
            <div class="btn-grid">
                <div class="tool-btn" onclick="setTool('mclaren', 'ping')" data-type="ping">DP <span class="hk">A</span></div>
                <div class="tool-btn" onclick="setTool('mclaren_catback', 'ping')" data-type="ping">Catback <span class="hk">S</span></div>
            </div>
        </div>

        <!-- UTILS -->
        <div>
            <div class="section-header">UTILITY</div>
            <div class="btn-grid">
                <div class="tool-btn" onclick="setTool('delete', 'delete')" data-type="delete">TRASH <span class="hk">D</span></div>
                <div class="tool-btn" onclick="clearTags()" data-type="clear">CLEAR <span class="hk">ESC</span></div>
            </div>
        </div>

    </div>

    <!-- FOOTER ACTIONS -->
    <div class="sidebar-footer">
        <div class="output-bar">
            <span id="editStatusText">Ready for URL input.</span>
        </div>
        
        <button id="bakeBtn" class="copy-btn" onclick="copyJson()">COPY TAGS JSON</button>
    </div>
  </div>

<!-- LOGIC -->
<script type="module">
  // --- STATE ---
  let activeTool = null;
  let currentTags = [];
  let currentImage = { url: '' };
  let loadRequestId = 0; 
  let isImageLoaded = false;

  const TAG_NAMES = {
      'ppf': 'PPF', 'ceramic': 'Ceramic Coating', 'vinyl': 'Vinyl Wrap', 'tint': 'Window Tint', 'detail': 'Detailing',
      'stage1': 'Stage 1 Tuning', 'stage2': 'Stage 2 Tuning', 'stage3': 'Stage 3 Tuning', 'wikd': 'WIKD Tuning',
      'mclaren': '720S Downpipe', 'mclaren_catback': '720S Catback'
  };

  // --- DOM ---
  const els = {
    imgWrap: document.getElementById('imgWrap'),
    img: document.getElementById('targetImg'),
    prompt: document.getElementById('prompt'),
    promptText: document.getElementById('promptText'),
    clickLayer: document.getElementById('clickLayer'),
    markerContainer: document.getElementById('markerContainer'),
    addUrlInput: document.getElementById('addUrlInput'),
    projTitle: document.getElementById('projTitle'),
    projSubtitle: document.getElementById('projSubtitle'),
    bakeBtn: document.getElementById('bakeBtn'), 
    editStatusText: document.getElementById('editStatusText'),
    quickGuide: document.getElementById('quickGuide')
  };

  // --- GUIDE TOGGLE ---
  window.toggleGuide = () => {
      els.quickGuide.classList.toggle('open');
  };

  // --- IMAGE LOADER (Simplified) ---
  function setMainImage(src) {
      if (!src) return;

      const myId = ++loadRequestId;

      // 1. Reset UI
      els.imgWrap.style.display = 'none';
      els.prompt.style.display = 'block';
      els.promptText.textContent = "LOADING...";
      isImageLoaded = false;
      
      // 2. Load Image 
      const loader = new Image();
      
      loader.onload = () => {
          if (loadRequestId !== myId) return; 
          els.img.src = src; 
          els.imgWrap.style.display = 'block';
          els.prompt.style.display = 'none';
          els.promptText.textContent = "START HERE";
          isImageLoaded = true;
          els.editStatusText.textContent = "Image Loaded. Start Tagging.";
          
          // Reset tags on new image load
          currentTags = [];
          renderMarkers();
          
          // Try to generate title from URL (handles base64 too, checking first few chars)
          try {
              const urlObj = new URL(src.startsWith('data:') ? 'http://a.com/' + (src.substring(0, 100).match(/data:[^;]*/) || ['base64_image'])[0] : src);
              const pathSegments = urlObj.pathname.split('/');
              let suggestedName = pathSegments.pop() || pathSegments.pop() || 'Untitled';
              suggestedName = suggestedName.replace(/\.[^/.]+$/, "").replace(/[-_]/g, " ").replace(/\b\w/g, l => l.toUpperCase());
              els.projTitle.value = suggestedName;
          } catch(e) {
              els.projTitle.value = "Untitled Project";
          }
      };

      loader.onerror = () => {
          if (loadRequestId !== myId) return;
          els.promptText.textContent = "LOAD ERROR (Check URL)";
          els.editStatusText.textContent = "Image failed to load.";
          currentImage.url = '';
      };

      loader.src = src;
      currentImage.url = src;
  }

  // --- MANUAL URL INPUT ---
  window.handleUrlInput = (e) => {
      if (e.key === 'Enter') {
          e.preventDefault();
          const url = els.addUrlInput.value.trim();
          if (url) {
              setMainImage(url);
          }
      }
  }

  // --- OUTPUT / EXPORT LOGIC (Replaces bakeEntry) ---
  window.copyJson = () => {
      if(!isImageLoaded) {
          els.editStatusText.textContent = "Error: No Image Loaded.";
          els.editStatusText.style.color = "var(--c-danger)";
          setTimeout(() => { els.editStatusText.style.color = ""; els.editStatusText.textContent = "Ready for URL input."; }, 3000);
          return;
      }
      
      // 1. Compile output object
      const output = {
          projectTitle: els.projTitle.value.trim(),
          tagsSubtitle: els.projSubtitle.value.trim(),
          imageUrl: currentImage.url,
          markers: currentTags.map(t => ({
              id: t.id,
              type: t.type,
              x: t.x, // 0-100%
              y: t.y  // 0-100%
          }))
      };
      
      const jsonString = JSON.stringify(output, null, 2);
      
      // 2. Copy to clipboard
      navigator.clipboard.writeText(jsonString).then(() => {
          els.editStatusText.textContent = "JSON COPIED TO CLIPBOARD!";
          els.editStatusText.style.color = "var(--c-success)";
          setTimeout(() => { els.editStatusText.style.color = ""; els.editStatusText.textContent = "Ready for next export."; }, 3000);
      }).catch(err => {
          console.error('Copy failed', err);
          // Fallback for clipboard access issues (especially in iframe)
          const textarea = document.createElement('textarea');
          textarea.value = jsonString;
          document.body.appendChild(textarea);
          textarea.select();
          try {
              document.execCommand('copy');
              els.editStatusText.textContent = "JSON COPIED (Fallback)";
              els.editStatusText.style.color = "var(--c-success)";
              setTimeout(() => { els.editStatusText.style.color = ""; els.editStatusText.textContent = "Ready for next export."; }, 3000);
          } catch (e) {
              els.editStatusText.textContent = "Copy failed. Check console for JSON.";
              els.editStatusText.style.color = "var(--c-danger)";
              console.log("Generated JSON:", jsonString);
          }
          document.body.removeChild(textarea);
      });
  };

  // --- ACTIONS ---
  window.setTool = (id, type) => {
      activeTool = { id, type };
      document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
      const btn = document.querySelector(`.tool-btn[onclick*="'${id}'"]`);
      if(btn) btn.classList.add('active');
  };

  els.clickLayer.addEventListener('mousedown', (e) => {
      if (!activeTool) {
          els.editStatusText.textContent = "Select a Tool first";
          els.editStatusText.style.color = "var(--c-danger)";
          setTimeout(() => { els.editStatusText.style.color = ""; els.editStatusText.textContent = isImageLoaded ? "Image Loaded. Start Tagging." : "Ready for URL input."; }, 3000);
          return;
      }
      if (activeTool.id === 'delete') return;
      const rect = els.img.getBoundingClientRect();
      const tag = {
          id: activeTool.id, type: activeTool.type,
          x: parseFloat(((e.clientX - rect.left)/rect.width * 100).toFixed(2)),
          y: parseFloat(((e.clientY - rect.top)/rect.height * 100).toFixed(2))
      };
      currentTags.push(tag);
      renderMarkers();
  });

  function renderMarkers() {
      els.markerContainer.innerHTML = '';
      currentTags.forEach((t, i) => {
          const el = document.createElement('div');
          el.className = 'marker';
          el.dataset.type = t.type;
          el.style.left = t.x+'%'; el.style.top = t.y+'%';
          el.style.color = t.type==='service'?'#536DFE':(t.type==='nano'?'#FFF':'#9370DB');
          
          if(t.type === 'nano') {
             el.innerHTML = `<svg viewBox="0 0 30 26" fill="none"><path d="M15 2 L27 24 L3 24 Z" fill="rgba(20,20,20,0.4)" stroke="rgba(255,255,255,0.9)" stroke-width="2"/><path d="M15 13 L19 19 L11 19 Z" fill="${t.id==='stage2'?'#FDE047':t.id==='stage3'?'#f97316':t.id==='wikd'?'#FF3B30':'#fff'}"/></svg>`;
          }
          
          // ADD CUSTOM LABEL ELEMENT
          const label = document.createElement('div');
          label.className = 'marker-label';
          label.textContent = TAG_NAMES[t.id] || t.id;
          el.appendChild(label);
          
          el.onmousedown = (e) => {
              if(activeTool?.id === 'delete') {
                  e.stopPropagation(); currentTags.splice(i,1); renderMarkers();
              } else {
                  e.preventDefault(); e.stopPropagation();
                  const move = (ev) => {
                      const r = els.img.getBoundingClientRect();
                      t.x = Math.max(0,Math.min(100, (ev.clientX-r.left)/r.width*100));
                      t.y = Math.max(0,Math.min(100, (ev.clientY-r.top)/r.height*100));
                      el.style.left = t.x+'%'; el.style.top = t.y+'%';
                  };
                  const stop = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', stop); };
                  document.addEventListener('mousemove', move); document.addEventListener('mouseup', stop);
              }
          };
          els.markerContainer.appendChild(el);
      });
      // Always update subtitle with current tags
      els.projSubtitle.value = currentTags.map(t => TAG_NAMES[t.id] || t.id).join(', ');
  }

  window.resetTagsToAuto = () => {
      // Only useful if we have tags
      const autoString = currentTags.map(t => TAG_NAMES[t.id] || t.id).join(', ');
      els.projSubtitle.value = autoString;
  };

  // --- UTILS (Simplified) ---
  window.clearTags = () => { 
      if(isImageLoaded && confirm("Clear all tags for the current image?")) { 
          currentTags=[]; 
          renderMarkers(); 
      } else if (!isImageLoaded) {
          els.editStatusText.textContent = "No image to clear tags from.";
          els.editStatusText.style.color = "var(--c-danger)";
          setTimeout(() => { els.editStatusText.style.color = ""; els.editStatusText.textContent = "Ready for URL input."; }, 3000);
      }
  };
  
  // Shortcuts
  document.addEventListener('keydown', (e) => {
      if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;
      const k = e.key.toLowerCase();
      // Removed 'g' for quickgroup
      const map = {'1':'ppf','2':'ceramic','3':'vinyl','4':'tint','5':'detail','q':'stage1','w':'stage2','e':'stage3','r':'wikd','a':'mclaren','s':'mclaren_catback','d':'delete','escape':'clear'};
      if(map[k]) {
          if(map[k]==='clear') window.clearTags();
          else if(map[k]==='delete') window.setTool('delete', 'delete');
          else window.setTool(map[k], ['ppf','ceramic','vinyl','tint','detail'].includes(map[k])?'service':(['mclaren','mclaren_catback'].includes(map[k])?'ping':'nano'));
      }
  });

</script>
</body>
</html>
