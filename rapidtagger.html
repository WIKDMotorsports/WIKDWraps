<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rapid Tagger (Pro Cockpit)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg: #000000; 
      --panel: #0a0a0a; 
      --border: #222;
      --text: #e0e0e0; 
      --text-muted: #666;
      --accent: #536DFE;
      
      /* WIKD Colors */
      --c-service: #536DFE;
      --c-nano: #FFFFFF;
      --c-ping: #9370DB;
      --c-danger: #ef4444;
      --c-success: #00E676;
    }

    /* GLOBAL SCROLLBARS */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--panel); }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    * { box-sizing: border-box; outline: none; }

    body {
      margin: 0; height: 100vh; background: var(--bg); color: var(--text);
      font-family: 'Inter', sans-serif; 
      display: grid; 
      /* GRID: Left (280px) - Center (Flex) - Right (280px) */
      grid-template-columns: 280px 1fr 280px;
      overflow: hidden;
    }

    /* --- SIDEBAR STRUCTURE --- */
    .sidebar {
      background: var(--panel);
      display: flex; flex-direction: column;
      height: 100vh;
      z-index: 100;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .sidebar-left { border-right: 1px solid var(--border); }
    .sidebar-right { border-left: 1px solid var(--border); }
    
    .sidebar-header { 
        padding: 14px 16px; 
        border-bottom: 1px solid var(--border); 
        display: flex; justify-content: space-between; align-items: center; 
        background: #0f0f0f;
    }
    
    .sidebar-scroll { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 24px; }
    
    .sidebar-footer {
        padding: 16px; border-top: 1px solid var(--border);
        background: #0f0f0f;
    }

    /* TYPOGRAPHY */
    h2 { font-size: 16px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }
    
    .section-header { 
      font-family: 'Rajdhani', sans-serif;
      font-size: 12px; text-transform: uppercase; letter-spacing: 1px; 
      color: var(--accent); font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;
    }
    .section-header::after { content:''; flex:1; height:1px; background: #222; }

    /* STATUS BADGE */
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #333; box-shadow: 0 0 5px rgba(0,0,0,0.5); transition: 0.3s; }
    .status-dot.online { background: var(--c-success); box-shadow: 0 0 8px var(--c-success); }
    .status-dot.offline { background: var(--c-danger); box-shadow: 0 0 8px var(--c-danger); }

    /* INPUTS */
    .input-group { position: relative; }
    
    textarea.batch-input {
      width: 100%; background: #141414; border: 1px solid #2a2a2a; color: #fff;
      padding: 10px 12px; font-family: monospace; height: 40px; resize: none; font-size: 12px; border-radius: 6px;
      transition: all 0.2s;
    }
    
    input.info-input {
      width: 100%; 
      background: #141414; 
      border: 1px solid #2a2a2a; 
      color: #e0e0e0;
      padding: 10px 12px; font-family: 'Inter', sans-serif; font-size: 12px; border-radius: 6px;
      transition: all 0.2s;
    }
    
    textarea.batch-input:focus, input.info-input:focus { 
        border-color: var(--accent); background: #1a1a1a; 
        box-shadow: 0 0 0 1px rgba(83, 109, 254, 0.2);
    }
    
    .input-label { font-size: 10px; color: var(--text-muted); margin-bottom: 4px; display: block; font-weight: 500; transition: color 0.2s; }

    /* LOCKED STATE (Orange Theme) */
    .locked-ui { 
        pointer-events: none; 
    }
    .locked-ui input.info-input {
        border-color: #ffa500;
        color: #ffa500;
        background: rgba(255, 165, 0, 0.08);
        box-shadow: 0 0 8px rgba(255, 165, 0, 0.1);
    }
    .locked-ui .input-label {
        color: #ffa500;
    }

    /* QUEUE LIST */
    .queue-container {
        background: #050505; border: 1px solid var(--border); border-radius: 6px; overflow: hidden;
        margin-bottom: 10px;
    }
    .queue-list { max-height: 80px; overflow-y: auto; }
    .queue-list:empty { padding: 10px; text-align: center; color: #444; font-style: italic; font-size: 10px; }
    .queue-list:empty::after { content: 'Upload Queue Empty'; }
    
    .q-item {
        padding: 4px 10px; border-bottom: 1px solid #1a1a1a; font-size: 10px;
        color: #888; display: flex; align-items: center; justify-content: space-between; gap: 10px;
        cursor: pointer; transition: 0.1s;
    }
    .q-item:hover { background: #111; color: #ccc; }
    .q-del { width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
    .q-del:hover { background: rgba(239, 68, 68, 0.2); color: var(--c-danger); }

    /* CLOUD GALLERY (THUMBNAILS) */
    .gallery-grid {
        display: grid; 
        grid-template-columns: repeat(3, 1fr); 
        gap: 8px; 
        margin-top: 10px;
        padding: 8px;
        background: #050505;
        border: 1px solid var(--border);
        border-radius: 6px;
        max-height: 350px;
        overflow-y: auto;
    }
    .gallery-item {
        aspect-ratio: 1;
        background: #111;
        border-radius: 4px;
        overflow: hidden;
        cursor: pointer;
        border: 2px solid transparent; /* Colored by JS */
        position: relative;
        transition: transform 0.1s;
    }
    .gallery-item:hover { transform: scale(1.05); z-index: 10; filter: brightness(1.2); }
    .gallery-item img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
    
    /* Indicator for currently editing item */
    .gallery-item.editing { 
        box-shadow: 0 0 0 2px #fff, 0 0 15px rgba(255, 255, 255, 0.3); 
        z-index: 5; 
        transform: scale(0.95);
    }
    
    /* TOOL GRID */
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    .tool-btn {
      position: relative;
      background: #141414; border: 1px solid #2a2a2a;
      color: #888; padding: 12px 4px; border-radius: 6px;
      cursor: pointer; font-size: 11px; font-weight: 600; text-align: center;
      transition: all 0.1s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px;
    }
    .tool-btn:hover { background: #1f1f1f; color: #fff; border-color: #444; }
    
    /* Active States */
    .tool-btn.active { background: #1f1f1f; border-color: currentColor; box-shadow: inset 0 0 0 1px currentColor; }
    .tool-btn[data-type="service"].active { color: var(--c-service); }
    .tool-btn[data-type="nano"].active { color: var(--c-nano); }
    .tool-btn[data-type="ping"].active { color: var(--c-ping); }
    
    .tool-btn[data-type="delete"]:hover { border-color: var(--c-danger); color: var(--c-danger); }
    .tool-btn[data-type="delete"].active { background: var(--c-danger); color: #fff; border-color: var(--c-danger); }
    
    .hk { position: absolute; top: 3px; right: 5px; font-size: 8px; opacity: 0.3; font-family: monospace; }

    /* BAKE BUTTON */
    .bake-btn {
        width: 100%; padding: 14px; 
        background: var(--c-success);
        border: none; border-radius: 6px;
        color: #000; font-family: 'Rajdhani', sans-serif; font-size: 16px; font-weight: 800;
        text-transform: uppercase; cursor: pointer; letter-spacing: 1px;
        transition: 0.2s;
    }
    .bake-btn:hover { filter: brightness(1.1); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 230, 118, 0.2); }
    .bake-btn:active { transform: translateY(1px); }
    
    .bake-btn.update-mode { background: #FFA500; color: #000; box-shadow: 0 4px 12px rgba(255, 165, 0, 0.2); }
    
    .cancel-btn {
        width: 100%; padding: 8px; background: #222; border: 1px solid #333; color: #888;
        border-radius: 4px; margin-top: 8px; font-size: 10px; cursor: pointer; text-transform: uppercase;
    }
    .cancel-btn:hover { background: #333; color: #fff; }

    /* DELETE BUTTON */
    .delete-btn {
        width: 100%; padding: 8px; background: rgba(239, 68, 68, 0.1); 
        border: 1px solid rgba(239, 68, 68, 0.3); color: var(--c-danger);
        border-radius: 4px; margin-top: 4px; font-size: 10px; cursor: pointer; text-transform: uppercase; font-weight: 700;
        transition: 0.2s;
    }
    .delete-btn:hover { background: var(--c-danger); color: #fff; }
    .delete-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* CANVAS AREA */
    .canvas-area {
      position: relative; background: #000; 
      display: flex; align-items: center; justify-content: center;
      overflow: hidden;
      box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
    }
    .upload-prompt { pointer-events: none; text-align: center; color: #333; font-family: 'Rajdhani', sans-serif; }
    
    .img-wrap { position: relative; box-shadow: 0 0 50px #000; max-width: 95%; max-height: 95%; }
    img#targetImg { display: block; max-width: 100%; max-height: 95vh; pointer-events: none; }
    .click-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; z-index: 10; }

    /* MARKERS */
    .marker {
      position: absolute; width: 24px; height: 24px; transform: translate(-50%, -50%);
      pointer-events: auto; cursor: grab; z-index: 20; display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: bold; text-shadow: 0 1px 2px #000; transition: transform 0.1s;
    }
    .marker[data-type="service"] { border-radius: 50%; border: 2px solid #fff; background: rgba(0,0,0,0.5); }
    .marker[data-type="service"]::after { content:''; width: 6px; height: 6px; background: currentColor; border-radius: 50%; }
    .marker[data-type="nano"] { width: 30px; height: 26px; }
    .marker[data-type="ping"] { width: 20px; height: 20px; border: 2px solid #fff; background: rgba(0,0,0,0.6); border-radius: 2px; }
    .marker[data-type="ping"]::after { content:''; width: 6px; height: 6px; background: currentColor; }
    
    .marker svg { width: 100%; height: 100%; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.8)); }

    /* OUTPUT & EXTRAS */
    .output-bar {
        font-size: 10px; color: #555; display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;
    }
    .lock-toggle {
        font-size: 10px; color: #555; background: none; border: 1px solid #333; padding: 2px 6px; border-radius: 3px; cursor: pointer;
    }
    .lock-toggle.active { color: #ffa500; border-color: #ffa500; background: rgba(255, 165, 0, 0.1); }
    /* .locked-ui styled above */

    @media (max-width: 1000px) {
        body { grid-template-columns: 240px 1fr 240px; }
    }
  </style>
</head>
<body>

  <!-- LEFT SIDEBAR: ASSETS & INFO -->
  <div class="sidebar sidebar-left">
    <div class="sidebar-header">
      <div style="display:flex; align-items:center; gap:10px;">
          <div id="statusDot" class="status-dot offline" title="Status"></div>
          <h2 style="margin:0">RAPID TAGGER</h2>
      </div>
      <button onclick="initAuth()" style="background:none; border:none; color:#444; font-size:10px; cursor:pointer;">RECONNECT</button>
    </div>

    <div class="sidebar-scroll">
      
      <!-- 1. SOURCE -->
      <div>
        <div class="section-header">1. SOURCE</div>
        <div class="input-group" style="display:flex; gap:6px; margin-bottom:8px;">
             <textarea id="addUrlInput" class="batch-input" placeholder="Paste Image URL..."></textarea>
             <button onclick="document.getElementById('fileInput').click()" id="uploadBtn" style="background:#222; border:1px solid #333; color:#fff; border-radius:6px; width:40px; cursor:pointer;">ðŸ“·</button>
             <input type="file" id="fileInput" accept="image/*" hidden>
        </div>
        
        <div class="queue-container">
            <div id="queueList" class="queue-list"></div>
        </div>
      </div>

      <!-- 2. PROJECT INFO -->
      <div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div class="section-header" style="margin:0">2. METADATA</div>
            <button id="lockBtn" class="lock-toggle" onclick="toggleLock()" title="Click to Unlock/Edit">ðŸ”“</button>
        </div>
        <div id="projectInfoContainer" style="display:flex; flex-direction:column; gap:10px;">
            <div>
                <span class="input-label">ORDER / SEQUENCE ID</span>
                <input type="text" id="projOrder" class="info-input" placeholder="Optional: Group or Sort ID (e.g. 101)">
            </div>

            <div>
                <span class="input-label">PROJECT TITLE</span>
                <input type="text" id="projTitle" class="info-input" placeholder="e.g. McLaren 720S">
            </div>
            <div>
                <span class="input-label">TAGS (AUTO)</span>
                <input type="text" id="projSubtitle" class="info-input" placeholder="Generated..." style="color:#e0e0e0;">
            </div>
        </div>
      </div>
      
      <!-- 3. CLOUD GALLERY (THUMBNAILS) -->
      <div>
          <details style="font-size:11px; color:#555; border:1px solid #222; border-radius:6px; margin-bottom:10px;">
              <summary style="padding:8px; cursor:pointer;">Quick Guide</summary>
              <div style="padding:8px; line-height:1.5;">
                  1. Paste URL or Upload.<br>
                  2. Add Tags -> BAKE.<br>
                  3. <b>Click below</b> to Edit Existing.
              </div>
          </details>

          <div class="section-header">CLOUD GALLERY <span id="galleryCount" style="font-size:9px; color:#666; margin-left:auto">0</span></div>
          <div id="galleryGrid" class="gallery-grid">
              <!-- Thumbnails populated from Firestore -->
          </div>
      </div>

    </div>
  </div>


  <!-- CENTER: CANVAS -->
  <div class="canvas-area">
    <div class="upload-prompt" id="prompt">
      <h1 id="promptText" style="font-size:40px; opacity:0.1; letter-spacing:4px;">DROP ZONE</h1>
    </div>
    
    <div class="img-wrap" id="imgWrap" style="display:none">
      <img id="targetImg">
      <div class="click-layer" id="clickLayer"></div>
      <div id="markerContainer"></div>
    </div>
  </div>


  <!-- RIGHT SIDEBAR: TOOLS & ACTIONS -->
  <div class="sidebar sidebar-right">
    <div class="sidebar-header" style="justify-content:center;">
        <span style="font-size:10px; font-weight:700; color:#555; letter-spacing:1px;">TOOLBOX</span>
    </div>
    
    <div class="sidebar-scroll">
        
        <!-- SERVICE TAGS -->
        <div>
            <div class="section-header">SERVICES</div>
            <div class="btn-grid">
                <div class="tool-btn" onclick="setTool('ppf', 'service')" data-type="service">PPF <span class="hk">1</span></div>
                <div class="tool-btn" onclick="setTool('ceramic', 'service')" data-type="service">Ceramic <span class="hk">2</span></div>
                <div class="tool-btn" onclick="setTool('vinyl', 'service')" data-type="service">Vinyl <span class="hk">3</span></div>
                <div class="tool-btn" onclick="setTool('tint', 'service')" data-type="service">Tint <span class="hk">4</span></div>
                <div class="tool-btn" onclick="setTool('detail', 'service')" data-type="service">Detail <span class="hk">5</span></div>
            </div>
        </div>

        <!-- TUNING -->
        <div>
            <div class="section-header">PERFORMANCE / NANO</div>
            <div class="btn-grid">
                <div class="tool-btn" onclick="setTool('stage1', 'nano')" data-type="nano">Stage 1 <span class="hk">Q</span></div>
                <div class="tool-btn" onclick="setTool('stage2', 'nano')" data-type="nano">Stage 2 <span class="hk">W</span></div>
                <div class="tool-btn" onclick="setTool('stage3', 'nano')" data-type="nano">Stage 3 <span class="hk">E</span></div>
                <div class="tool-btn" onclick="setTool('wikd', 'nano')" data-type="nano">WIKD <span class="hk">R</span></div>
            </div>
        </div>

        <!-- PRODUCTS -->
        <div>
            <div class="section-header">PARTS / PING</div>
            <div class="btn-grid">
                <div class="tool-btn" onclick="setTool('mclaren', 'ping')" data-type="ping">DP <span class="hk">A</span></div>
                <div class="tool-btn" onclick="setTool('mclaren_catback', 'ping')" data-type="ping">Catback <span class="hk">S</span></div>
            </div>
        </div>

        <!-- UTILS -->
        <div>
            <div class="section-header">UTILITY</div>
            <div class="btn-grid">
                <div class="tool-btn" onclick="setTool('delete', 'delete')" data-type="delete">TRASH <span class="hk">D</span></div>
                <div class="tool-btn" onclick="clearTags()" data-type="clear">CLEAR <span class="hk">ESC</span></div>
            </div>
        </div>

    </div>

    <!-- FOOTER ACTIONS -->
    <div class="sidebar-footer">
        <div class="output-bar">
            <span id="editStatusText">New Entry Mode</span>
        </div>
        
        <button id="bakeBtn" class="bake-btn" onclick="bakeEntry()">BAKE TO DATABASE</button>
        <button id="cancelBtn" class="cancel-btn" onclick="cancelEdit()" style="display:none">CANCEL EDIT</button>
        <button id="deleteEntryBtn" class="delete-btn" onclick="window.deleteEntry()" style="display:none">TRASH ENTRY</button>
    </div>
  </div>

<!-- LOGIC -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // --- CONFIG ---
  const firebaseConfig = {
    apiKey: "AIzaSyDmsposy-HZm_Nbfz6UlQfgQscG3jsidy8",
    authDomain: "rapid-tagger-wikd-edition.firebaseapp.com",
    projectId: "rapid-tagger-wikd-edition",
    storageBucket: "rapid-tagger-wikd-edition.firebasestorage.app",
    messagingSenderId: "127611552314",
    appId: "1:127611552314:web:169fe01257a451eab2ab03"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const appId = 'wikd-tagger';
  const COL_NAME = 'wikd_gallery';

  // --- AUTH ---
  let currentUser = null;
  const statusDot = document.getElementById('statusDot');

  const initAuth = async () => {
    try {
      if(!auth.currentUser) await signInAnonymously(auth);
      currentUser = auth.currentUser;
      statusDot.className = 'status-dot online';
      setupListener(); 
    } catch(e) { 
        console.error("Auth failed", e);
        statusDot.className = 'status-dot offline';
    }
  };
  window.initAuth = initAuth;
  initAuth();

  // --- STATE ---
  let activeTool = null;
  let currentTags = [];
  let masterList = [];
  let urlQueue = [];
  let currentItem = null;
  let debounceTimer;
  let isLocked = false;
  let editingId = null;
  let loadRequestId = 0; 
  let deleteConfirmTimer = null;

  const TAG_NAMES = {
      'ppf': 'PPF', 'ceramic': 'Ceramic Coating', 'vinyl': 'Vinyl Wrap', 'tint': 'Window Tint', 'detail': 'Detailing',
      'stage1': 'Stage 1 Tuning', 'stage2': 'Stage 2 Tuning', 'stage3': 'Stage 3 Tuning', 'wikd': 'WIKD Tuning',
      'mclaren': '720S Downpipe', 'mclaren_catback': '720S Catback'
  };

  // --- DOM ---
  const els = {
    imgWrap: document.getElementById('imgWrap'),
    img: document.getElementById('targetImg'),
    prompt: document.getElementById('prompt'),
    promptText: document.getElementById('promptText'),
    clickLayer: document.getElementById('clickLayer'),
    markerContainer: document.getElementById('markerContainer'),
    addUrlInput: document.getElementById('addUrlInput'),
    queueList: document.getElementById('queueList'),
    galleryGrid: document.getElementById('galleryGrid'),
    galleryCount: document.getElementById('galleryCount'),
    projTitle: document.getElementById('projTitle'),
    projSubtitle: document.getElementById('projSubtitle'),
    projOrder: document.getElementById('projOrder'),
    lockBtn: document.getElementById('lockBtn'),
    projInfo: document.getElementById('projectInfoContainer'),
    fileInput: document.getElementById('fileInput'),
    uploadBtn: document.getElementById('uploadBtn'),
    bakeBtn: document.getElementById('bakeBtn'),
    cancelBtn: document.getElementById('cancelBtn'),
    deleteEntryBtn: document.getElementById('deleteEntryBtn'),
    editStatusText: document.getElementById('editStatusText')
  };

  // --- COLOR GENERATOR (TITLE + SUBTITLE) ---
  const stringToColor = (str) => {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      const c = (hash & 0x00ffffff).toString(16).toUpperCase();
      return '#' + '00000'.substring(0, 6 - c.length) + c;
  };

  // --- DETACHED PRELOADER V5.1 (CORS Fallback) ---
  function setMainImage(src) {
      if (!src) return;

      const myId = ++loadRequestId;

      // 1. Reset UI
      els.imgWrap.style.display = 'none';
      els.prompt.style.display = 'block';
      els.promptText.textContent = "LOADING...";
      
      // 2. Memory Load (Try Safe First)
      const loader = new Image();
      loader.crossOrigin = "anonymous"; 
      
      const success = (imgObj) => {
          if (loadRequestId !== myId) return; 
          els.img.removeAttribute('src'); 
          // If this success came from fallback, remove crossOrigin from DOM element
          if(imgObj.crossOrigin !== "anonymous") els.img.removeAttribute('crossorigin');
          else els.img.setAttribute('crossorigin', 'anonymous');

          els.img.src = src; 
          els.imgWrap.style.display = 'block';
          els.prompt.style.display = 'none';
          els.promptText.textContent = "DROP ZONE";
      };

      const fail = () => {
          if (loadRequestId !== myId) return;
          console.warn("Standard load failed, trying permissive mode...");
          // Fallback: No CORS attribute. Will display but might taint canvas (ok for markers)
          const fallback = new Image();
          fallback.referrerPolicy = "no-referrer";
          fallback.onload = () => success(fallback);
          fallback.onerror = () => {
              if (loadRequestId !== myId) return;
              els.promptText.textContent = "LOAD ERROR";
          };
          fallback.src = src;
      };

      loader.onload = () => success(loader);
      loader.onerror = fail;
      loader.src = src;
  }

  // --- FIRESTORE & GALLERY LOGIC ---
  function setupListener() {
      onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', COL_NAME), (snapshot) => {
          masterList = [];
          snapshot.forEach((doc) => masterList.push({ dbId: doc.id, ...doc.data() }));
          
          // --- SORTING LOGIC: GROUP BY PROJECT ---
          const groups = {};
          
          masterList.forEach(item => {
              // Create Key from Title + Subtitle
              const t = (item.title || "").trim().toLowerCase();
              const s = (item.subtitle || "").trim().toLowerCase();
              const key = t + "::" + s;
              
              if (!groups[key]) groups[key] = { items: [], maxDate: 0 };
              groups[key].items.push(item);
              
              // Track newest item in group
              const d = new Date(item.createdAt).getTime();
              if(d > groups[key].maxDate) groups[key].maxDate = d;
          });

          // Sort Groups by their newest content (Last Active)
          const sortedKeys = Object.keys(groups).sort((a, b) => groups[b].maxDate - groups[a].maxDate);
          
          // Rebuild Master List from Sorted Groups
          masterList = [];
          sortedKeys.forEach(k => {
              // Sort items within group (Newest First)
              groups[k].items.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
              masterList.push(...groups[k].items);
          });
          
          renderGallery();
      });
  }

  function renderGallery() {
      els.galleryCount.textContent = masterList.length;
      els.galleryGrid.innerHTML = '';
      
      masterList.forEach(item => {
          const div = document.createElement('div');
          // Add 'editing' class if this is the active item
          div.className = `gallery-item ${item.dbId === editingId ? 'editing' : ''}`;
          
          // Generate color from Title + Subtitle to match main site
          const t = (item.title || "").trim().toLowerCase();
          const s = (item.subtitle || "").trim().toLowerCase();
          const colorKey = t + "::" + s; // Using separator to ensure distinct keys
          div.style.borderColor = stringToColor(colorKey || 'default');
          
          div.onclick = () => loadForEdit(item.dbId);
          div.title = `${item.title} (${item.tags?.length || 0} tags)`;

          const img = document.createElement('img');
          // Check both fields for the URL
          const src = item.imageUrl || item.cdnUrl;
          img.src = src;
          img.loading = "lazy"; 
          // Do not set crossOrigin here to allow CDNs to load without headers
          
          div.appendChild(img);
          els.galleryGrid.appendChild(div);
      });
  }

  // --- EDIT LOGIC (FIXED) ---
  window.loadForEdit = (id) => {
      const item = masterList.find(i => i.dbId === id);
      if(!item) return;

      // 1. Reset Global State for new load
      loadRequestId++; // Kill any pending queue loads
      editingId = id;
      
      // 2. Update UI Inputs
      els.projTitle.value = item.title || '';
      els.projSubtitle.value = item.subtitle || '';
      els.projOrder.value = item.orderId || '';
      
      // 3. LOCK UI by default to prevent accidental grouping changes
      window.toggleLock(true);

      // 4. Load Image (Check cdnUrl fallback)
      const src = item.imageUrl || item.cdnUrl;
      if (src && typeof src === 'string') {
        currentItem = { data: src, name: item.title }; 
        setMainImage(src);
      } else {
        currentItem = null;
        els.promptText.textContent = "NO DATA";
      }
      
      // 5. Set Tags
      currentTags = item.tags || [];
      renderMarkers();
      
      // 6. Update Buttons & Gallery Visuals
      els.bakeBtn.textContent = "UPDATE ENTRY";
      els.bakeBtn.classList.add('update-mode');
      els.cancelBtn.style.display = 'block';
      els.deleteEntryBtn.style.display = 'block'; // Show Delete Button
      // Reset delete button state
      els.deleteEntryBtn.innerText = "TRASH ENTRY";
      els.deleteEntryBtn.style.background = "";
      els.deleteEntryBtn.style.color = "";
      els.deleteEntryBtn.dataset.confirm = "false";
      
      els.editStatusText.textContent = `Editing: ${item.title || 'Untitled'}`;
      
      renderGallery(); // Re-render to show selection border
  };
  
  window.cancelEdit = () => {
      editingId = null;
      els.bakeBtn.textContent = "BAKE TO DATABASE";
      els.bakeBtn.classList.remove('update-mode');
      els.cancelBtn.style.display = 'none';
      els.deleteEntryBtn.style.display = 'none'; // Hide Delete Button
      els.editStatusText.textContent = "New Entry Mode";
      
      els.projTitle.value = '';
      els.projSubtitle.value = '';
      els.projOrder.value = '';
      
      // Unlock for new entry creation
      window.toggleLock(false);

      currentTags = [];
      renderMarkers();
      
      if(urlQueue.length > 0) {
          loadNext();
      } else {
          loadRequestId++; 
          els.img.removeAttribute('src');
          els.imgWrap.style.display = 'none';
          els.prompt.style.display = 'block';
          els.promptText.textContent = "DROP ZONE";
          currentItem = null;
      }
      renderGallery();
  };

  // POPUP-FREE DELETE LOGIC (2-Step Tap)
  window.deleteEntry = async () => {
      if(!editingId) return;

      const btn = els.deleteEntryBtn;
      
      // State 1: Ask for confirmation
      if (btn.dataset.confirm !== "true") {
          btn.dataset.confirm = "true";
          btn.innerText = "âš ï¸ CONFIRM DELETE?";
          btn.style.background = "#ef4444";
          btn.style.color = "white";
          
          // Reset if not clicked within 3 seconds
          clearTimeout(deleteConfirmTimer);
          deleteConfirmTimer = setTimeout(() => {
              btn.dataset.confirm = "false";
              btn.innerText = "TRASH ENTRY";
              btn.style.background = "";
              btn.style.color = "";
          }, 3000);
          return;
      }
      
      // State 2: Execute
      clearTimeout(deleteConfirmTimer);
      btn.innerText = "DELETING...";
      btn.disabled = true;
      
      try {
          await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', COL_NAME, editingId));
          // Success
          els.editStatusText.textContent = "Entry Deleted";
          els.editStatusText.style.color = "var(--c-success)";
          setTimeout(() => { els.editStatusText.style.color = ""; els.editStatusText.textContent = "New Entry Mode"; }, 3000);
          
          editingId = null; 
          cancelEdit();
      } catch(e) {
          console.error(e);
          els.editStatusText.textContent = "Delete Failed";
          els.editStatusText.style.color = "var(--c-danger)";
          // Reset button
          btn.innerText = "TRASH ENTRY";
          btn.disabled = false;
          btn.dataset.confirm = "false";
          btn.style.background = "";
      }
  };

  // --- SAVE / UPDATE ---
  window.bakeEntry = async () => {
      if(!currentItem) {
          els.editStatusText.textContent = "Error: No Image";
          els.editStatusText.style.color = "var(--c-danger)";
          return;
      }
      
      const entry = {
          title: els.projTitle.value.trim(),
          subtitle: els.projSubtitle.value.trim(),
          orderId: els.projOrder.value.trim(),
          tags: [...currentTags],
          createdAt: new Date().toISOString(),
          // Persist the URL regardless of where it came from
          imageUrl: currentItem.data
      };
      
      if(new Blob([JSON.stringify(entry)]).size > 1000000) {
          els.editStatusText.textContent = "Error: File too big (>1MB)";
          els.editStatusText.style.color = "var(--c-danger)";
          return;
      }

      els.bakeBtn.disabled = true;
      els.bakeBtn.innerText = "SAVING...";

      try {
          if (editingId) {
              await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', COL_NAME, editingId), entry);
              els.editStatusText.textContent = "Entry Updated Successfully";
              els.editStatusText.style.color = "var(--c-success)";
              setTimeout(() => { els.editStatusText.style.color = ""; }, 3000);
              
              // Slight delay before reset to show success state
              setTimeout(() => { 
                  cancelEdit(); 
                  els.bakeBtn.disabled = false; 
              }, 500);
          } else {
              await addDoc(collection(db, 'artifacts', appId, 'public', 'data', COL_NAME), entry);
              els.editStatusText.textContent = "New Entry Baked!";
              els.editStatusText.style.color = "var(--c-success)";
              setTimeout(() => { els.editStatusText.style.color = ""; els.editStatusText.textContent = "New Entry Mode"; }, 3000);
              
              // Only shift queue if we were processing the queue, not editing
              if(!editingId && urlQueue.length > 0) urlQueue.shift();
              
              currentTags = [];
              renderMarkers();
              loadNext();
              els.bakeBtn.innerText = "BAKE TO DATABASE";
              els.bakeBtn.disabled = false;
          }
      } catch(e) { 
          els.editStatusText.textContent = "Save Failed: " + e.message;
          els.editStatusText.style.color = "var(--c-danger)";
          els.bakeBtn.innerText = editingId ? "UPDATE ENTRY" : "BAKE TO DATABASE";
          els.bakeBtn.disabled = false;
      }
  };


  // --- COMPRESSION (1920px / 1MB) ---
  const compressImage = async (file) => {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = URL.createObjectURL(file);
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const MAX_WIDTH = 1920; 
            let width = img.width;
            let height = img.height;
            if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            
            const MAX_BYTES = 1020000;
            let quality = 0.95; 
            let dataUrl = canvas.toDataURL('image/jpeg', quality);
            
            while (dataUrl.length > MAX_BYTES && quality > 0.1) {
                let step = 0.05;
                if (dataUrl.length > MAX_BYTES * 1.5) step = 0.15; 
                quality -= step;
                dataUrl = canvas.toDataURL('image/jpeg', Math.max(0.1, quality));
            }
            resolve(dataUrl);
        };
        img.onerror = reject;
    });
  };

  // --- UPLOAD & QUEUE LOGIC ---
  els.fileInput.addEventListener('change', async (e) => {
      if(e.target.files?.[0]) {
          const file = e.target.files[0];
          els.uploadBtn.textContent = '...';
          try {
              const base64 = await compressImage(file);
              urlQueue.unshift({ type: 'base64', data: base64, name: file.name });
              renderQueueList();
              if(!currentItem && !editingId) loadNext();
          } catch(err) { console.error(err); alert("Image failed"); }
          els.uploadBtn.textContent = 'ðŸ“·';
          els.fileInput.value = '';
      }
  });

  els.addUrlInput.addEventListener('input', (e) => {
    if(!e.target.value.trim()) return;
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        e.target.value.split(/[\n\r]+/).filter(l=>l.length>5).forEach(line => {
            let cleanUrl = line.trim();
            const name = cleanUrl.split('/').pop().split('?')[0] || 'Link';
            urlQueue.push({ type: 'url', data: cleanUrl, name: name });
        });
        e.target.value = '';
        renderQueueList();
        if(!currentItem && !editingId) loadNext();
    }, 400);
  });

  function renderQueueList() {
      els.queueList.innerHTML = '';
      urlQueue.forEach((item, i) => {
          const div = document.createElement('div');
          div.className = 'q-item';
          div.innerHTML = `<div style="flex:1;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">${item.name}</div><div class="q-del" onclick="removeFromQueue(${i})">Ã—</div>`;
          els.queueList.appendChild(div);
      });
  }

  window.removeFromQueue = (i) => {
      urlQueue.splice(i, 1);
      if(i===0 && !editingId) { currentTags = []; renderMarkers(); loadNext(); }
      else renderQueueList();
  };

  function loadNext() {
      if(editingId) return; 
      
      if(!urlQueue.length) {
          loadRequestId++; 
          currentItem = null;
          els.img.removeAttribute('src');
          els.imgWrap.style.display = 'none';
          els.prompt.style.display = 'block';
          els.promptText.textContent = "DROP ZONE";
          if(!isLocked) { els.projTitle.value=''; els.projSubtitle.value=''; els.projOrder.value=''; }
          renderQueueList();
          return;
      }
      
      currentItem = urlQueue[0];
      
      if (!currentItem || !currentItem.data) {
        urlQueue.shift(); 
        loadNext(); 
        return;
      }
      
      setMainImage(currentItem.data);
      
      if(!isLocked) {
          const title = currentItem.name.replace(/\.[^/.]+$/, "").replace(/[-_]/g, " ").replace(/\b\w/g, l => l.toUpperCase());
          els.projTitle.value = title;
          els.projSubtitle.value = "";
          els.projOrder.value = "";
      }
      renderQueueList();
  }

  // --- ACTIONS ---
  window.setTool = (id, type) => {
      activeTool = { id, type };
      document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
      const btn = document.querySelector(`.tool-btn[onclick*="'${id}'"]`);
      if(btn) btn.classList.add('active');
  };

  els.clickLayer.addEventListener('mousedown', (e) => {
      if (!activeTool) return alert("Select a Tool first");
      if (activeTool.id === 'delete') return;
      const rect = els.img.getBoundingClientRect();
      const tag = {
          id: activeTool.id, type: activeTool.type,
          x: parseFloat(((e.clientX - rect.left)/rect.width * 100).toFixed(2)),
          y: parseFloat(((e.clientY - rect.top)/rect.height * 100).toFixed(2))
      };
      currentTags.push(tag);
      renderMarkers();
  });

  function renderMarkers() {
      els.markerContainer.innerHTML = '';
      currentTags.forEach((t, i) => {
          const el = document.createElement('div');
          el.className = 'marker';
          el.dataset.type = t.type;
          el.style.left = t.x+'%'; el.style.top = t.y+'%';
          el.style.color = t.type==='service'?'#536DFE':(t.type==='nano'?'#FFF':'#9370DB');
          
          if(t.type === 'nano') {
             el.innerHTML = `<svg viewBox="0 0 30 26" fill="none"><path d="M15 2 L27 24 L3 24 Z" fill="rgba(20,20,20,0.4)" stroke="rgba(255,255,255,0.9)" stroke-width="2"/><path d="M15 13 L19 19 L11 19 Z" fill="${t.id==='stage2'?'#FDE047':t.id==='stage3'?'#f97316':t.id==='wikd'?'#FF3B30':'#fff'}"/></svg>`;
          }
          
          el.onmousedown = (e) => {
              if(activeTool?.id === 'delete') {
                  e.stopPropagation(); currentTags.splice(i,1); renderMarkers();
              } else {
                  e.preventDefault(); e.stopPropagation();
                  const move = (ev) => {
                      const r = els.img.getBoundingClientRect();
                      t.x = Math.max(0,Math.min(100, (ev.clientX-r.left)/r.width*100));
                      t.y = Math.max(0,Math.min(100, (ev.clientY-r.top)/r.height*100));
                      el.style.left = t.x+'%'; el.style.top = t.y+'%';
                  };
                  const stop = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', stop); };
                  document.addEventListener('mousemove', move); document.addEventListener('mouseup', stop);
              }
          };
          els.markerContainer.appendChild(el);
      });
      if(!isLocked) els.projSubtitle.value = currentTags.map(t => TAG_NAMES[t.id] || t.id).join(', ');
  }

  // --- UTILS ---
  window.toggleLock = (forceState) => {
      if (typeof forceState === 'boolean') {
          isLocked = forceState;
      } else {
          isLocked = !isLocked;
      }
      els.lockBtn.textContent = isLocked ? 'ðŸ”’' : 'ðŸ”“';
      els.lockBtn.classList.toggle('active', isLocked);
      els.projInfo.classList.toggle('locked-ui', isLocked);
  };
  
  window.clearTags = () => { if(confirm("Clear tags?")) { currentTags=[]; renderMarkers(); }};
  
  // Shortcuts
  document.addEventListener('keydown', (e) => {
      if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;
      const k = e.key.toLowerCase();
      const map = {'1':'ppf','2':'ceramic','3':'vinyl','4':'tint','5':'detail','q':'stage1','w':'stage2','e':'stage3','r':'wikd','a':'mclaren','s':'mclaren_catback','d':'delete','escape':'clear'};
      if(map[k]) {
          if(map[k]==='clear') window.clearTags();
          else if(map[k]==='delete') window.setTool('delete', 'delete');
          else window.setTool(map[k], ['ppf','ceramic','vinyl','tint','detail'].includes(map[k])?'service':(['mclaren','mclaren_catback'].includes(map[k])?'ping':'nano'));
      }
  });

</script>
</body>
</html>
